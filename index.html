<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Hub</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="assets/image/icon-192.png">
    <style>
        :root {
            --header-bg: #333;
            --header-text: #fff;
            --blue-bar: #4a86e8;
            --highlight-yellow: #ffff00;
            --highlight-green: #008000;
            --highlight-red: #ff0000;
            --bg-gray: #f5f5f5;
            --border-color: #ccc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Header */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 0 20px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-weight: bold;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            height: 100%;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #aaa;
            padding: 0 20px;
            cursor: pointer;
            font-weight: bold;
            height: 100%;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #fff;
            border-bottom: 3px solid var(--blue-bar);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Main Content Grid */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
        }

        /* Left Side (Typing Area) */
        .left-pane {
            flex: 3;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            background: white;
            min-width: 0;
            /* Fix flex overflow */
        }

        .info-bar {
            background-color: #e0e0e0;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
        }

        .blue-header {
            background-color: #4387cc;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 14px;
        }

        .typing-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            overflow-y: auto;
        }

        .text-box {
            border: 1px solid black;
            padding: 15px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 18px;
            line-height: 1.6;
            overflow-y: auto;
            flex: 1;
            white-space: pre-wrap;
        }

        .input-box {
            border: 2px solid #4387cc;
            padding: 15px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 18px;
            line-height: 1.6;
            flex: 1;
            resize: none;
        }

        /* Exam Mode Highlights */
        span.word-pending {
            color: black;
        }

        span.word-current {
            background-color: var(--highlight-yellow);
        }

        span.word-correct {
            color: var(--highlight-green);
        }

        span.word-wrong {
            color: var(--highlight-red);
        }

        /* Practice Mode Highlights */
        span.char-correct {
            color: green;
            background-color: #e6ffFA;
        }

        span.char-wrong {
            color: red;
            background-color: #ffe6e6;
        }

        span.char-current {
            text-decoration: underline;
            background-color: #eee;
        }

        /* Right Side (Sidebar) */
        .right-pane {
            flex: 1;
            background-color: #f9f9f9;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 250px;
            overflow-y: auto;
            border-left: 2px solid #ccc;
        }

        .profile-section {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
        }

        .profile-img {
            width: 50px;
            height: 50px;
            background: #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #ddd;
        }

        .stats-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .stats-table td:first-child {
            font-weight: bold;
            color: #555;
        }

        .instructions {
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            font-size: 12px;
            color: #444;
        }

        .instructions h4 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        /* Footer */
        footer {
            background-color: #e0f0f5;
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: flex-end;
        }

        .btn-submit {
            background-color: #0275d8;
            color: white;
            border: none;
            padding: 8px 25px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn-submit:hover {
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-title">Typing Hub</div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchMode('exam')" id="btn-exam">Exam Mode</button>
            <button class="tab-btn" onclick="switchMode('practice')" id="btn-practice">Practice Mode</button>
        </div>
        <div style="display:flex; align-items:center; gap: 15px;">
            <button id="btn-start-test" onclick="startTest()"
                style="background: #5cb85c; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-weight: bold;">Start
                Test</button>
            <button id="btn-reset-test" onclick="manualReset()"
                style="background: #d9534f; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-weight: bold;"
                disabled>Reset Passage</button>
            <div style="font-size: 14px;">Time Left: <span id="timer">10:00</span></div>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Pane -->
        <div class="left-pane">
            <div class="info-bar">
                <div>
                    <span
                        style="background: #0275d8; color: white; padding: 3px 8px; font-size: 12px; border-radius: 3px;">Section
                        A</span>
                </div>
                <div>Server Time: <span id="server-time">--:--</span></div>
            </div>

            <div class="blue-header">Keyboard Layout: QWERTY</div>

            <div class="typing-area">
                <div class="text-box" id="quoteDisplay"></div>
                <!-- Added disabled attribute initially -->
                <textarea class="input-box" id="quoteInput" placeholder="Click 'Start Test' to begin..."
                    spellcheck="false" disabled></textarea>
            </div>
        </div>

        <!-- Right Pane -->
        <div class="right-pane">
            <div class="profile-section">
                <div class="profile-img">ðŸ‘¤</div>
                <div><strong>Candidate Name</strong><br>User</div>
            </div>

            <table class="stats-table">
                <tr>
                    <td>Keystrokes Count</td>
                    <td id="stat-keystrokes">0</td>
                </tr>
                <tr>
                    <td>Backspace Count</td>
                    <td id="stat-backspace">0</td>
                </tr>
                <tr>
                    <td>Total Word Count</td>
                    <td id="stat-total-words">0</td>
                </tr>
                <tr>
                    <td>Typed Word Count</td>
                    <td id="stat-typed-words">0</td>
                </tr>
                <tr>
                    <td>Pending Word Count</td>
                    <td id="stat-pending-words">0</td>
                </tr>
                <tr>
                    <td>Error Count</td>
                    <td id="stat-errors" class="sensitive-stat">0</td>
                </tr>
                <tr>
                    <td>Gross WPM</td>
                    <td id="stat-gwpm" class="sensitive-stat">0</td>
                </tr>
                <tr>
                    <td>Net WPM</td>
                    <td id="stat-nwpm" class="sensitive-stat">0</td>
                </tr>
                <tr>
                    <td>Accuracy</td>
                    <td id="stat-accuracy" class="sensitive-stat">0%</td>
                </tr>
            </table>

            <div class="instructions">
                <h4>Instructions</h4>
                <ul style="padding-left: 20px; margin: 0;">
                    <li id="instr-1">Highlighting will guide you to current word.</li>
                    <li>Green/Red indicates Correct/Wrong words.</li>
                    <li>Avoid using backspace to maximize score.</li>
                    <li>Submit manually or auto-submit on timeout.</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        <button class="btn-submit" onclick="finishTest()">Submit</button>
    </footer>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Test Summary</h2>
            <div id="resultBody"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn-submit" style="background:#d9534f;" onclick="resetTest()">Close & Reset</button>
            </div>
        </div>
    </div>

    <script>

        // State Elements
        const quoteDisplay = document.getElementById('quoteDisplay');
        const quoteInput = document.getElementById('quoteInput');
        const btnStart = document.getElementById('btn-start-test');
        const btnReset = document.getElementById('btn-reset-test');

        // Stats Elements
        const elKeystrokes = document.getElementById('stat-keystrokes');
        const elBackspace = document.getElementById('stat-backspace');
        const elTotalWords = document.getElementById('stat-total-words');
        const elTypedWords = document.getElementById('stat-typed-words');
        const elPendingWords = document.getElementById('stat-pending-words');
        const elErrors = document.getElementById('stat-errors');
        const elGwpm = document.getElementById('stat-gwpm');
        const elNwpm = document.getElementById('stat-nwpm');
        const elAccuracy = document.getElementById('stat-accuracy');
        const elTimer = document.getElementById('timer');
        const modal = document.getElementById('resultModal');

        let mode = 'exam'; // 'exam' or 'practice'
        let timerInterval;
        let timeLimit = 10 * 60; // 10 mins
        let timeLeft = timeLimit;
        let isRunning = false;

        // Passages Data (Embedded for local compatibility)
        let passages = [
            "India's G20 Presidency marked a historic milestone in the country's diplomatic journey, showcasing its emergence as a global leader capable of bridging the divide between the Global North and the Global South. The theme 'Vasudhaiva Kutumbakam' or 'One Earth, One Family, One Future' resonated deeply with the international community, emphasizing the interconnectedness of all life forms and the need for collaborative action to address global challenges. During its presidency, India prioritized issues such as inclusive growth, digital public infrastructure, climate financing, and women-led development. The New Delhi Leaders' Declaration was a significant achievement, demonstrating India's ability to forge consensus on contentious geopolitical issues. The inclusion of the African Union as a permanent member of the G20 was a testament to India's commitment to inclusivity and representation for developing nations. The presidency also highlighted India's rich cultural heritage and diversity through meetings held across various cities, boosting tourism and local economies. Furthermore, the focus on digital transformation showcased India's prowess in technology and its potential to provide scalable solutions for the world. As the baton passed to Brazil, India's legacy remained one of unity, determination, and a vision for a sustainable and equitable future for all humanity.",
            "The Digital India initiative, launched in 2015, has transformed the nation into a digitally empowered society and knowledge economy. By ensuring high-speed internet connectivity to rural areas, promoting digital literacy, and developing secure digital infrastructure, the program has bridged the digital divide and brought government services to the fingertips of citizens. A cornerstone of this revolution is the Unified Payments Interface (UPI), which has gained global recognition for its efficiency and scale, revolutionizing how Indians transact daily. Direct Benefit Transfers (DBT) enabled by the JAM trinity (Jan Dhan, Aadhaar, Mobile) have ensured that welfare subsidies reach the intended beneficiaries directly, curbing leakages and corruption. The proliferation of smartphones and affordable data has further fueled the growth of e-commerce, ed-tech, and health-tech sectors, creating new avenues for employment and entrepreneurship. Initiatives like DigiLocker have simplified document verification, while the ONDC (Open Network for Digital Commerce) aims to democratize digital commerce. However, challenges such as cybersecurity threats and the need for robust data protection laws remain. As India moves towards a trillion-dollar digital economy, the focus must remain on inclusivity, ensuring that the benefits of technology reach the last mile and empower every citizen.",
            "Chandrayaan-3's successful soft landing on the moon's south pole was a momentous occasion that etched India's name in the history of space exploration. This achievement made India the fourth country to land on the moon and the first to reach the uncharted lunar south pole region. The mission demonstrated ISRO's resilience and engineering prowess, bouncing back from the partial failure of its predecessor. The Vikram lander and Pragyan rover conducted in-situ scientific experiments, studying the lunar surface's thermal properties, seismic activity, and elemental composition. The discovery of sulphur and other elements provided crucial insights into the moon's geological history. Beyond the scientific gains, Chandrayaan-3 ignited a passion for science and technology among India's youth and bolstered the country's reputation as a cost-effective and reliable space power. The mission's success has opened doors for deeper international collaboration and future interplanetary expeditions. It also underscored the potential of India's private space sector, which is witnessing rapid growth. As India aims for the stars with upcoming missions like Gaganyaan, the spirit of Chandrayaan-3 serves as a beacon of inspiration, proving that with determination and innovation, even the sky is not the limit.",
            "India's startup ecosystem has witnessed exponential growth over the past decade, evolving into the third-largest in the world. Driven by a young and aspirational population, affordable internet, and a supportive policy environment, Indian startups are solving complex problems across diverse sectors. From fintech and e-commerce to health-tech and agritech, entrepreneurs are leveraging technology to create value and drive social impact. The rise of unicornsâ€”startups valued at over a billion dollarsâ€”has been rapid, signaling the maturity and investor confidence in the Indian market. Government initiatives like 'Startup India' have played a catalytic role by providing tax benefits, simplifying regulations, and setting up fund-of-funds. Innovation hubs and incubators in academic institutions are nurturing the next generation of founders. However, the ecosystem faces challenges such as funding winters, regulatory hurdles, and the need for sustainable business models. Deep-tech and manufacturing startups, in particular, require patient capital and long-term support. As the ecosystem matures, the focus is shifting from valuation to value creation, corporate governance, and profitability. With a vast domestic market and global ambitions, Indian startups are poised to play a pivotal role in the country's journey towards becoming a developed nation by 2047.",
            "Infrastructure development has been a central pillar of India's growth strategy, with the government aggressively pushing for modernization to enhance connectivity and economic efficiency. The PM Gati Shakti National Master Plan is a transformative approach to coordinate infrastructure planning and execution across various ministries. The rapid expansion of the highway network, the dedicated freight corridors, and the modernization of railways with Vande Bharat trains are revolutionizing logistics and travel. The aviation sector is also witnessing a boom with the construction of new airports under the UDAN scheme, making air travel accessible to smaller cities. Urban infrastructure is being upgraded through the Smart Cities Mission and the expansion of metro rail networks in major cities. Additionally, the focus on renewable energy infrastructure, such as solar parks and green hydrogen hubs, aligns with India's climate goals. These developments are not only creating jobs but also attracting foreign investment by reducing the cost of doing business. However, ensuring the sustainability and maintenance of these assets is crucial. As India builds for the future, the emphasis must be on resilient, eco-friendly, and inclusive infrastructure that caters to the needs of a growing population and a dynamic economy."
        ];

        // Data Tracking
        let originalText = "";
        let originalWords = [];
        let backspaceCount = 0;
        let startTime = null;

        // Server Time Clock
        function updateServerTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('server-time').innerText = timeString;
        }
        setInterval(updateServerTime, 1000);
        updateServerTime();

        function switchMode(newMode) {
            mode = newMode;
            document.getElementById('btn-exam').classList.toggle('active', mode === 'exam');
            document.getElementById('btn-practice').classList.toggle('active', mode === 'practice');

            // Text for instructions
            const instrContainer = document.querySelector('.instructions ul');
            if (mode === 'exam') {
                instrContainer.innerHTML = `
                    <li>Kindly type the highlighted word to proceed further.</li>
                    <li>Kindly note, you can edit the text contents that you have typed.</li>
                    <li>Correct/Wrong words turn Green/Red respectively.</li>
                    <li>Kindly note, it is mandatory for you to type the entire text contents to submit.</li>
                    <li>Upon timeout, the system will automatically save all your responses.</li>
                    <li><strong>Note: Performance stats are hidden until submission.</strong></li>
                `;
            } else {
                instrContainer.innerHTML = `
                    <li>Practice Mode: Immediate character-level feedback.</li>
                    <li>Green background indicates correct characters.</li>
                    <li>Red background indicates incorrect characters.</li>
                    <li>Real-time accuracy and WPM tracking.</li>
                `;
            }

            resetTest();
        }

        function init() {
            // Pick random passage
            originalText = passages[Math.floor(Math.random() * passages.length)];
            // Normalize spaces
            originalText = originalText.replace(/\s+/g, ' ').trim();
            originalWords = originalText.split(' ');

            renderText();
            quoteInput.value = '';

            // Disable input until Start is clicked
            quoteInput.disabled = true;
            quoteInput.placeholder = "Click 'Start Test' to begin...";

            btnStart.style.display = 'block'; // Show Start Button
            // btnReset state: Enabled when NOT running (Idle)
            // User requested: "disabled during the test"
            btnReset.disabled = false;

            // Stats Reset
            backspaceCount = 0;
            timeLeft = timeLimit;
            elTimer.innerText = "10:00";

            updateStatsUI(0, 0, 0, 0, 0, 0, 0, 0);
        }

        function startTest() {
            if (isRunning) return;
            isRunning = true;
            quoteInput.disabled = false;
            quoteInput.value = "";
            quoteInput.focus();
            quoteInput.placeholder = "Type here...";

            btnStart.style.display = 'none'; // Hide Start Button
            btnReset.disabled = true; // Disable Reset during test

            startTime = new Date();
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const s = (timeLeft % 60).toString().padStart(2, '0');
                    elTimer.innerText = `${m}:${s}`;
                    executeStatsLogic(); // Update time-dependent stats
                } else {
                    finishTest();
                }
            }, 1000);
        }

        function renderText() {
            quoteDisplay.innerHTML = '';

            if (mode === 'exam') {
                // Word-based rendering
                originalWords.forEach((word, index) => {
                    const span = document.createElement('span');
                    span.innerText = word + " "; // Add space visual
                    span.id = `word-${index}`;
                    span.className = 'word-pending';
                    quoteDisplay.appendChild(span);
                });
                // Highlight first word
                if (originalWords.length > 0) {
                    document.getElementById('word-0').className = 'word-current';
                }
            } else {
                // Character-based rendering (Practice Mode)
                originalText.split('').forEach((char, index) => {
                    const span = document.createElement('span');
                    span.innerText = char;
                    span.id = `char-${index}`;
                    quoteDisplay.appendChild(span);
                });
            }

            elTotalWords.innerText = originalWords.length;
            elPendingWords.innerText = originalWords.length;
        }

        quoteInput.addEventListener('keydown', (e) => {
            if (!isRunning) return; // Should be disabled anyway
            if (e.key === 'Backspace') {
                backspaceCount++;
                elBackspace.innerText = backspaceCount;
            }
        });

        quoteInput.addEventListener('input', () => {
            if (!isRunning) return;

            if (mode === 'exam') {
                handleExamInput();
            } else {
                handlePracticeInput();
            }
            executeStatsLogic();
        });

        // --- EXAM MODE LOGIC (Word Based) ---
        // --- EXAM MODE LOGIC (Word Based Limit, Char Based Validation) ---
        function handleExamInput() {
            const currentInput = quoteInput.value;
            const currentLength = currentInput.length;

            // Re-calculate word start/end indices on the fly (or could cache in init)
            // We assume originalText is single-spaced as normalized in init()
            let charIndex = 0;

            originalWords.forEach((word, idx) => {
                const el = document.getElementById(`word-${idx}`);
                if (!el) return;

                const start = charIndex;
                const end = charIndex + word.length; // Exclusive end of word content
                // Next char is space (except last word)
                charIndex = end + 1;

                // Reset styles
                el.className = '';
                el.style.backgroundColor = '';
                el.style.color = '';

                // Logic based on input cursor position relative to this word
                if (currentLength > end) {
                    // Cursor is past this word (including the space after it)
                    // Or at least past the word. Check if space was typed? 
                    // Strict mode: Check if the segment in currentInput matches exactly

                    const userSegment = currentInput.substring(start, end);
                    if (userSegment === word) {
                        el.className = 'word-correct';
                    } else {
                        el.className = 'word-wrong';
                    }
                } else if (currentLength >= start) {
                    // Cursor is INSIDE this word
                    el.className = 'word-current';

                    // Check if what's typed SO FAR for this word is correct
                    const userSegment = currentInput.substring(start, currentLength);
                    const targetSegment = word.substring(0, userSegment.length);

                    if (userSegment !== targetSegment) {
                        // Error in current typing
                        el.style.backgroundColor = 'var(--highlight-yellow)';
                        el.style.color = 'red';
                    } else {
                        // Correct so far
                        el.style.backgroundColor = 'var(--highlight-yellow)';
                        el.style.color = 'black';
                    }
                } else {
                    // Cursor not reached yet
                    el.className = 'word-pending';
                }
            });
        }

        // --- PRACTICE MODE LOGIC (Char Based) ---
        function handlePracticeInput() {
            const val = quoteInput.value;
            const arr = val.split('');
            const spans = quoteDisplay.querySelectorAll('span');

            spans.forEach((span, i) => {
                const char = arr[i];
                if (char == null) {
                    span.className = ''; // Reset
                    if (i === arr.length) span.className = 'char-current';
                } else if (char === span.innerText) {
                    span.className = 'char-correct';
                } else {
                    span.className = 'char-wrong';
                }
            });
        }

        // --- SCORING & STATS ---
        function executeStatsLogic() {
            const text = quoteInput.value;
            const keystrokes = text.length;

            const typedWordsList = text.trim().split(/\s+/);
            const typedWordsCount = text.trim() === '' ? 0 : typedWordsList.length;

            let errorCount = 0;

            if (mode === 'exam') {
                const inputList = text.split(/\s+/);
                inputList.forEach((w, i) => {
                    if (i < inputList.length - 1) {
                        if (originalWords[i] && w !== originalWords[i]) {
                            errorCount += w.length;
                        }
                    }
                });
            } else {
                for (let i = 0; i < text.length; i++) {
                    if (i < originalText.length && text[i] !== originalText[i]) {
                        errorCount++;
                    }
                }
            }

            const timeElapsedMin = (timeLimit - timeLeft) / 60;
            const validTime = timeElapsedMin === 0 ? 0.001 : timeElapsedMin;

            const gwpm = Math.round((keystrokes / 5) / validTime);

            const grossWords = keystrokes / 5;
            const penalty = errorCount / 5;
            const netWords = Math.max(0, grossWords - penalty);
            const nwpm = Math.round(netWords / validTime);

            const acc = gwpm > 0 ? Math.round((nwpm * 100) / gwpm) : 100;

            const pending = Math.max(0, originalWords.length - typedWordsCount);

            updateStatsUI(keystrokes, backspaceCount, originalWords.length, typedWordsCount, pending, errorCount, gwpm, nwpm, acc);
        }

        function updateStatsUI(k, b, tot, typ, pen, err, g, n, a) {
            // Always update basic counters
            elKeystrokes.innerText = k;
            elBackspace.innerText = b;
            elTotalWords.innerText = tot;
            elTypedWords.innerText = typ;
            elPendingWords.innerText = pen;

            // Conditional update for performance stats
            if (mode === 'exam' && isRunning) {
                // HIDE live stats in Exam Mode
                elErrors.innerText = "--";
                elGwpm.innerText = "--";
                elNwpm.innerText = "--";
                elAccuracy.innerText = "--";
            } else {
                // SHOW live stats in Practice Mode OR if stopped (Result)
                elErrors.innerText = err;
                elGwpm.innerText = g;
                elNwpm.innerText = n;
                elAccuracy.innerText = a + "%";
            }
        }

        function finishTest() {
            clearInterval(timerInterval);
            isRunning = false;
            quoteInput.disabled = true;

            // Force final update to reveal stats in Exam Mode
            // Re-run stats logic with isRunning = false to populate UI
            executeStatsLogic();

            // Show Modal with Final Values
            const body = document.getElementById('resultBody');
            body.innerHTML = `
                <p><strong>Net WPM:</strong> <span style="font-size: 20px; color: blue;">${elNwpm.innerText}</span></p>
                <p><strong>Accuracy:</strong> ${elAccuracy.innerText}</p>
                <p><strong>Gross WPM:</strong> ${elGwpm.innerText}</p>
                <p><strong>Errors (Chars):</strong> ${elErrors.innerText}</p>
                <p><strong>Keystrokes:</strong> ${elKeystrokes.innerText}</p>
            `;
            modal.style.display = 'flex';
        }

        function resetTest() {
            modal.style.display = 'none';
            clearInterval(timerInterval);
            isRunning = false;
            init();
        }

        // Manual passage refresh (Button Click)
        function manualReset() {
            if (isRunning) return; // Should be disabled anyway
            resetTest();
        }

        // Start on load
        window.onload = init;

        // Disable paste
        quoteInput.onpaste = e => e.preventDefault();

    </script>
</body>

</html>